<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Spare Parts Data</title>
<style>
/* ===== Mixed UI: clean new look + restored features ===== */
:root{
  --bg:#f5f6fa; --card:#fff; --muted:#7d8794; --primary:#007bff; --text:#222;
  --dark-bg:#2c3e50; --dark-card:#34495e; --dark-text:#ecf0f1;
}
body{
  font-family: Arial, sans-serif;
  margin:20px;
  background:var(--bg);
  color:var(--text);
  transition: background .2s,color .2s;
}
body.dark{ background:var(--dark-bg); color:var(--dark-text); }
h2{ margin:0 0 10px 0; font-size:32px; color:inherit; }
#status{ color:var(--muted); margin-bottom:10px; font-style:italic; }
/* Top bar & buttons */
.topbar{ display:flex; gap:10px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
.btn{ padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
.btn-primary{ background:var(--primary); color:#fff; box-shadow:0 2px 0 rgba(0,0,0,0.05); }
.btn-secondary{ background:#eee; color:#222; border-radius:6px; }
/* toggles */
.toggles{ display:flex; gap:12px; align-items:center; margin-left:6px; }
.toggle{ position:relative; width:50px; height:26px; display:inline-block; }
.toggle input{ opacity:0; width:0; height:0; }
.slider{ position:absolute; inset:0; background:#ccc; border-radius:26px; transition:0.2s; }
.slider:before{ content:""; position:absolute; left:3px; bottom:3px; width:20px; height:20px; background:#fff; border-radius:50%; transition:0.2s; }
.toggle input:checked + .slider{ background:var(--primary); }
.toggle input:checked + .slider:before{ transform:translateX(24px); }
/* Search box */
#search{ padding:12px; width:420px; max-width:100%; border-radius:8px; border:1px solid #ccc; margin:10px 0; }
/* Table */
table{ width:100%; border-collapse:collapse; background:var(--card); border-radius:8px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.06); }
th{ background:#e6e9f0; padding:10px; text-align:left; border-bottom:1px solid #dcdde1; }
td{ padding:10px; border-bottom:1px solid #efefef; }
.compact td,.compact th{ padding:6px; font-size:13px; }
body.dark table{ background:var(--dark-card); }
body.dark th{ background:var(--dark-bg); color:var(--dark-text); border-bottom-color:#555; }
body.dark td{ border-bottom-color:#3a4a59; }
/* Pagination */
.pagination{ margin-top:16px; display:flex; align-items:center; gap:8px; }
/* Scanner modal (SMALL centered modal) */
.modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:9999; }
.modal{ width:640px; max-width:94%; background:var(--card); border-radius:10px; padding:14px; box-shadow:0 8px 30px rgba(0,0,0,0.3); max-height:86vh; overflow:hidden; display:flex; flex-direction:column; }
.modal-header{ font-size:18px; color:#666; margin:0 0 8px; }
#qr-reader{ width:100%; height:360px; background:#000; display:flex; align-items:center; justify-content:center; color:#999; overflow:hidden; border-radius:8px; position:relative; }
.scan-tools{ display:flex; justify-content:space-between; gap:10px; margin-top:10px; align-items:center; }
.scan-btn{ padding:10px 14px; border-radius:6px; border:1px solid var(--primary); background:#fff; color:var(--primary); cursor:pointer; }
.modal-footer{ text-align:right; margin-top:10px; }
/* ensure close always visible and modal content scrollable if needed */
.modal-body{ overflow:auto; flex:1; }
/* dark variant for modal */
body.dark .modal{ background:var(--dark-card); color:var(--dark-text); }
/* responsive */
@media (max-width:600px){
  .modal{ width:94%; padding:10px; }
  #qr-reader{ height:260px; }
  #search{ width:100%; }
}
  .scan-success {
  box-shadow: 0 0 22px rgba(0,255,0,0.9);
  transition: box-shadow 0.2s ease;
}
   /* ===== Dark mode table grid lines ===== */
body.dark th,
body.dark td {
  border-bottom: 1px solid rgba(255,255,255,0.12);
}

body.dark table {
  box-shadow: 0 2px 8px rgba(0,0,0,0.4);
}

</style>
<script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
<div id="status">Loading data...</div>
<h2>Spare Parts Search</h2>

<div class="topbar">
  <button id="btn-scan" class="btn btn-primary">üì∑ Scan (QR / Barcode)</button>
    <!-- ADD THIS LINE -->
  <button id="btn-add" class="btn btn-primary">‚ûï Add Spare Part</button>
  <script>
document.getElementById("btn-add").addEventListener("click", function () {
  window.open(
    "https://docs.google.com/forms/d/e/1FAIpQLSdYtCErU2QugovcnGLHkPOd_G0owZKzYadJdXXgaxwa9ZGegg/viewform",
    "_blank"
  );
});
</script>

  <button id="btn-refresh" class="btn btn-secondary">‚Üª Refresh</button>
  <div style="flex:1"></div>
  <div class="toggles" title="Toggles">
    <label style="display:flex;flex-direction:column;align-items:center;font-size:12px;">
      <div style="margin-bottom:6px;">Dark</div>
      <label class="toggle"><input id="darkToggle" type="checkbox"><span class="slider"></span></label>
    </label>
    <label style="display:flex;flex-direction:column;align-items:center;font-size:12px;">
      <div style="margin-bottom:6px;">Compact</div>
      <label class="toggle"><input id="compactToggle" type="checkbox"><span class="slider"></span></label>
    </label>
  </div>
</div>
<input id="search" type="text" placeholder="Search part / description / category / qty">
<table>
  <thead>
    <tr><th>S.No</th><th>Item No</th><th>Part No</th><th>Description</th><th>Category</th><th>Qty</th></tr>
  </thead>
  <tbody id="table-body"></tbody>
</table>
<div class="pagination">
  <button id="prev-page" class="btn btn-secondary">Prev</button>
  <span id="page-info"></span>
  <button id="next-page" class="btn btn-secondary">Next</button>
</div>
<br>
<input id="jumpPage" type="number" placeholder="Go to page"><button onclick="jumpToPage()" class="btn btn-secondary">Go</button>
<!-- SMALL SCANNER MODAL -->
<div id="qr-backdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Scanner modal">
    <div class="modal-body">
      <h3 class="modal-header">Scanner (QR + Barcode)</h3>
      <div id="qr-reader">Camera preview will appear here</div>
      <div class="scan-tools">
        <div style="display:flex;gap:8px;">
          <button id="btn-flash" class="scan-btn">üî¶ Flash</button>
          <button id="btn-photo" class="scan-btn">üñºÔ∏è Scan From Photo</button>
        </div>
        <div style="font-size:13px;color:#666;">Tip: center code inside the preview</div>
      </div>
    </div>
    <div class="modal-footer">
      <button id="qr-close" class="btn btn-secondary">Close</button>
    </div>
  </div>
</div>
<script>
/* ===================== ORIGINAL APP / SHEETDB LOGIC (PRESERVED) ===================== */
/* ===================== OPTIMIZED APP + SHEETDB (REPLACEMENT) ===================== */
let items = [];
let currentPage = 1;
const perPage = 50;

const statusEl = document.getElementById('status');
const searchEl = document.getElementById('search');
const tbody = document.getElementById('table-body');
const pageInfo = document.getElementById('page-info');
const prevBtn = document.getElementById('prev-page');
const nextBtn = document.getElementById('next-page');
const refreshBtn = document.getElementById('btn-refresh');

const SHEETDB_BASE = "https://sheetdb.io/api/v1/bvdsyfvkla1lv";
const CACHE_KEY = "sheetdb_cache_v1";

/* ========== THEME STATE ========== */
let isDark = localStorage.getItem('darkMode') === 'true';
let isCompact = localStorage.getItem('compactMode') === 'true';

document.body.classList.toggle('dark', isDark);
document.body.classList.toggle('compact', isCompact);
darkToggle.checked = isDark;
compactToggle.checked = isCompact;

darkToggle.onchange = () => {
  isDark = !isDark;
  document.body.classList.toggle('dark', isDark);
  localStorage.setItem('darkMode', isDark);
};

compactToggle.onchange = () => {
  isCompact = !isCompact;
  document.body.classList.toggle('compact', isCompact);
  localStorage.setItem('compactMode', isCompact);
};

/* ========== HELPERS ========== */
const cleanKeys = row => {
  const fixed = {};
  for (const k in row) fixed[k.trim()] = String(row[k]).trim();
  return fixed;
};

/* ========== FAST RENDER ========== */
function display(list, startIndex) {
  tbody.textContent = "";
  const frag = document.createDocumentFragment();

  for (let i = 0; i < list.length; i++) {
    const r = list[i];
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${startIndex + i + 1}</td>
      <td>${r["item no"] || ""}</td>
      <td>${r["part no"] || ""}</td>
      <td>${r["description"] || ""}</td>
      <td>${r["category"] || ""}</td>
      <td>${r["qty"] || ""}</td>
    `;
    frag.appendChild(tr);
  }
  tbody.appendChild(frag);
}

function render() {
  const q = searchEl.value.toLowerCase().trim();
  const words = q ? q.split(/\s+/) : [];

  const filtered = !words.length
    ? items
    : items.filter(r => {
        const text = (
          r["item no"] + " " +
          r["part no"] + " " +
          r["description"] + " " +
          r["category"] + " " +
          r["qty"]
        ).toLowerCase();
        return words.every(w => text.includes(w));
      });

  const totalPages = Math.max(1, Math.ceil(filtered.length / perPage));
  currentPage = Math.min(currentPage, totalPages);

  const start = (currentPage - 1) * perPage;
  display(filtered.slice(start, start + perPage), start);

  pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
  prevBtn.disabled = currentPage === 1;
  nextBtn.disabled = currentPage === totalPages;
}

/* ========== EVENTS ========== */
searchEl.oninput = () => { currentPage = 1; render(); };
prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; render(); } };
nextBtn.onclick = () => { currentPage++; render(); };

window.jumpToPage = () => {
  const p = +jumpPage.value;
  if (p > 0) { currentPage = p; render(); }
};

/* ========== FAST SHEETDB LOAD ========== */
async function loadData(force = false) {
  statusEl.textContent = "Loading‚Ä¶";

  if (!force) {
    const cached = sessionStorage.getItem(CACHE_KEY);
    if (cached) {
      items = JSON.parse(cached);
      statusEl.textContent = `Loaded ${items.length} records (cached)`;
      render();
      return;
    }
  }

  try {
    const res = await fetch(SHEETDB_BASE, { cache: "no-store" });
    const data = await res.json();
    items = data.map(cleanKeys);
    sessionStorage.setItem(CACHE_KEY, JSON.stringify(items));
    statusEl.textContent = `Loaded ${items.length} records`;
    render();
  } catch {
    statusEl.textContent = "Offline ‚Äì no data";
  }
}

loadData();
refreshBtn.onclick = () => loadData(true);
/* ===================== SCANNER ENHANCEMENTS (QR + EAN-13 photo fallback) ===================== */
let html5QrcodeLoaded = false;
let qrScanner = null;
let scanLock = false;
let torchOn = false;
// tiny beep (short sound)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ LOUD SUCCESS BEEP (copy-paste this instead) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const beep = new Audio("https://cdn.jsdelivr.net/gh/mdbassit/beep-sound@master/success.mp3");
function injectScriptText(code){
  return new Promise((resolve,reject)=>{
    try{
      const s=document.createElement('script');
      s.type='text/javascript';
      s.text = code;
      document.head.appendChild(s);
      html5QrcodeLoaded = true;
      resolve();
    }catch(e){ reject(e); }
  });
}
function tryLoadLocal(){
  return new Promise((resolve,reject)=>{
    if(html5QrcodeLoaded) return resolve();
    const s=document.createElement('script');
    s.src = "./html5-qrcode.min.js";
    s.onload = ()=>{ html5QrcodeLoaded=true; resolve(); };
    s.onerror = ()=>{ s.remove(); reject(new Error("local load failed")); };
    document.head.appendChild(s);
  });
}
function tryFetchRawGithub(){
  return new Promise((resolve,reject)=>{
    try{
      const hostname = window.location.hostname;
      const pathParts = (window.location.pathname||"/").split("/").filter(Boolean);
      let rawUrl = "https://raw.githubusercontent.com/mebjas/html5-qrcode/master/dist/html5-qrcode.min.js";
      if(hostname.endsWith("github.io") && pathParts.length>0){
        const username = hostname.split(".")[0];
        const repo = pathParts[0];
        rawUrl = `https://raw.githubusercontent.com/${username}/${repo}/main/html5-qrcode.min.js`;
      }
      fetch(rawUrl).then(r=>{
        if(!r.ok) throw new Error("raw fetch error "+r.status);
        return r.text();
      }).then(txt=>{
        if(!txt || txt.length < 200) throw new Error("raw file too small");
        return injectScriptText(txt);
      }).then(resolve).catch(reject);
    }catch(e){ reject(e); }
  });
}
async function loadHtml5QrcodeScript(){
  if(html5QrcodeLoaded) return;
  try{
    await tryLoadLocal();
    return;
  }catch(e){}
  try{
    await tryFetchRawGithub();
    return;
  }catch(e){}
  // final fallback to CDN (may be blocked)
  return new Promise((resolve,reject)=>{
    const s=document.createElement('script');
    s.src = "https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js";
    s.onload = ()=>{ html5QrcodeLoaded=true; resolve(); };
    s.onerror = ()=>reject(new Error("All attempts to load html5-qrcode failed."));
    document.head.appendChild(s);
  });
}
const qrBackdrop = document.getElementById('qr-backdrop');
const qrReader = document.getElementById('qr-reader');
const btnScan = document.getElementById('btn-scan');
const btnClose = document.getElementById('qr-close');
const btnFlash = document.getElementById('btn-flash');
const btnPhoto = document.getElementById('btn-photo');
btnScan.addEventListener('click', openQR);
btnClose.addEventListener('click', closeQR);
function safeClearScanner(){
  if(qrScanner){
    try{
      qrScanner.stop().then(()=>{ try{ qrScanner.clear(); }catch(e){} }).catch(()=>{});
    }catch(e){}
    qrScanner = null;
  }
  torchOn = false;
}
function getScannerVideoElement(){
  if(!qrReader) return null;
  // html5-qrcode places a video element inside the container
  return qrReader.querySelector('video') || null;
}
async function setTorch(on){
  try{
    const video = getScannerVideoElement();
    if(!video || !video.srcObject) throw new Error("No video");
    const track = video.srcObject.getVideoTracks()[0];
    if(!track) throw new Error("No track");
    const cap = track.getCapabilities ? track.getCapabilities() : {};
    if(cap.torch){
      await track.applyConstraints({ advanced:[{ torch: on }] });
      torchOn = on;
      return true;
    }else{
      // best-effort attempt (may fail)
      await track.applyConstraints({ advanced:[{ torch: on }] }).catch(()=>{});
      return false;
    }
  }catch(e){
    return false;
  }
}
/* OPEN scanner - small modal */
async function openQR(){
  qrBackdrop.style.display = 'flex';
  qrBackdrop.setAttribute('aria-hidden','false');
  scanLock = false;
  safeClearScanner();
  qrReader.innerHTML = ""; // clear
  // ensure modal visible/rendered
  await new Promise(r => requestAnimationFrame(()=>setTimeout(r, 200)));
  try{
    await loadHtml5QrcodeScript();
  }catch(e){
    alert("Scanner library failed to load: "+(e && e.message? e.message : e));
    qrBackdrop.style.display = 'none';
    return;
  }
  try{
    qrScanner = new Html5Qrcode("qr-reader");
    const config = {
      fps: 10, // lower FPS = faster decode + stable focus
  qrbox: { width: 260, height: 260 }, // üîë SPEED KEY
  experimentalFeatures: {
    useBarCodeDetectorIfSupported: true
  },
  formatsToSupport: [
    Html5QrcodeSupportedFormats.QR_CODE,
    Html5QrcodeSupportedFormats.EAN_13
        
      ]
    };
    const cameraConfig = { facingMode: "environment" }; // only one key
    await qrScanner.start(
      cameraConfig,
      config,
      (decodedText, decodedResult) => {
      if (scanLock) return;
scanLock = true;

(be => be?.play?.().catch?.(() => {}))(beep);
navigator.vibrate?.(180);
qrReader.classList.add("scan-success");
setTimeout(() => qrReader.classList.remove("scan-success"), 200);

document.getElementById('search').value = decodedText;
currentPage = 1;
render();

closeQR(); // stop + clear happens inside
      },
      (error) => {
        // ignore frame decode errors
      }
    );
    // small delay to detect video element
  
  }catch(err){
    console.error("start error", err);
    alert("Camera failed to start: " + (err && err.message ? err.message : err));
    qrBackdrop.style.display = 'none';
    qrBackdrop.setAttribute('aria-hidden','true');
    safeClearScanner();
  }
}
/* CLOSE scanner */
function closeQR(){
  qrBackdrop.style.display = 'none';
  qrBackdrop.setAttribute('aria-hidden','true');
  safeClearScanner();
}
/* Flashlight toggle */
btnFlash.addEventListener('click', async ()=>{
  if(!qrScanner){
    alert("Open scanner first");
    return;
  }
  const ok = await setTorch(!torchOn);
  if(!ok) alert("Flash/torch not supported on this device/browser.");
});
/* ============ Scan From Photo (Option B) =============
   Strategy:
   1) try qrScanner.scanFile(file, tryFlip=true) => good for QR
   2) fallback: use BarcodeDetector (EAN-13) if available
   3) final fallback: draw to canvas + try html5-qrcode scan attempts
*/
btnPhoto.addEventListener('click', ()=> {
  // create hidden file input and read file via FileReader to prevent native preview
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.style.display = 'none';
  input.onchange = async (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    // Read the file into memory first - prevents some browsers' default preview behaviour
    const reader = new FileReader();
    reader.onload = async () => {
      // create blob from result
      try{
        await handleImageFile(file);
      }catch(err){
        alert("No QR or supported barcode found in image.");
      }
    };
    reader.onerror = ()=>{ alert("Failed to read file."); };
    reader.readAsArrayBuffer(file);
  };
  document.body.appendChild(input);
  input.click();
  // cleanup input after selection
  input.addEventListener('blur', ()=>input.remove());
});
async function handleImageFile(file){
  // ensure library loaded (for scanFile)
  try{ await loadHtml5QrcodeScript(); }catch(e){ throw new Error("library"); }
  // 1) try built-in scanFile (good for QR)
  try{
    // prefer instance method if available
    if(qrScanner && typeof qrScanner.scanFile === 'function'){
      const qrResult = await qrScanner.scanFile(file, true);
      if(qrResult){
        (be => be?.play?.().catch?.(() => {}))(beep); navigator.vibrate?.(180);
        document.getElementById('search').value = qrResult;
        currentPage = 1; render();
        return;
      }
    } else if(typeof Html5Qrcode === 'function'){
      // create temp instance
      const tmp = new Html5Qrcode(); // no container - used only for scanFile
      if(typeof tmp.scanFile === 'function'){
        const res = await tmp.scanFile(file, true);
        if(res){
          (be => be?.play?.().catch?.(() => {}))(beep); navigator.vibrate?.(180);
          document.getElementById('search').value = res;
          currentPage = 1; render();
          try{ tmp.clear(); }catch(e){};
          return;
        }
        try{ tmp.clear(); }catch(e){};
      }
    }
  }catch(e){
    // continue to fallback
  }
  // 2) Try BarcodeDetector (EAN-13) on ImageBitmap (fast when supported)
  try{
    if('BarcodeDetector' in window){
      const formats = ['ean_13']; // option B
      let detector;
      try{ detector = new BarcodeDetector({formats}); }catch(e){ detector = new BarcodeDetector(); }
      const imgBitmap = await createImageBitmap(file);
      const results = await detector.detect(imgBitmap);
      if(results && results.length>0){
        const val = results[0].rawValue || results[0].rawData || results[0].displayValue || results[0].rawText;
        if(val){
          (be => be?.play?.().catch?.(() => {}))(beep); navigator.vibrate?.(180);
          document.getElementById('search').value = val;
          currentPage = 1; render();
          return;
        }
      }
    }
  }catch(e){
    // ignore and continue
  }
  // 3) Last attempt: draw to canvas & use Html5Qrcode's decodeFromImage or scanFile again
  try{
    const img = document.createElement('img');
    img.src = URL.createObjectURL(file);
    await new Promise((res,rej)=>{ img.onload = res; img.onerror = rej; });
    // attempt decode using tmp instance
    if(typeof Html5Qrcode === 'function'){
      const tmp = new Html5Qrcode();
      try{
        const res = await tmp.scanFile(file, true); // attempt again
        if(res){
          (be => be?.play?.().catch?.(() => {}))(beep); navigator.vibrate?.(180);
          document.getElementById('search').value = res;
          currentPage = 1; render();
          try{ tmp.clear(); }catch(e){}
          img.remove();
          return;
        }
      }catch(e){}
      try{ tmp.clear(); }catch(e){};
    }
    img.remove();
  }catch(e){
    // nothing more
  }
  // final: not found
  // OCR fallback (printed text like Google Lens)
const ocrFound = await scanPrintedTextFromImage(file);
if (ocrFound) return;

// final: not found
throw new Error("not-found");
}
/* free camera when page unloaded */
window.addEventListener('pagehide', ()=>{ safeClearScanner(); });
window.addEventListener('beforeunload', ()=>{ safeClearScanner(); });

async function scanPrintedTextFromImage(file) {
  const { data } = await Tesseract.recognize(file, "eng", {
    tessedit_char_whitelist: "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-/"
  });

  const text = data.text.toUpperCase();

  // Detect part numbers (adjust pattern if needed)
  const match = text.match(/[A-Z0-9\-\/]{4,}/);

  if (match) {
    beep.play().catch(()=>{});
    navigator.vibrate?.(150);
    document.getElementById("search").value = match[0];
    currentPage = 1;
    render();
    alert("Detected text: " + match[0]);
    return true;
  }
  return false;
}
</script>
</body>
</html>
