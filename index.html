<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Spare Parts Search</title>

<!-- QR + Barcode -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<style>
:root{
  --bg:#f5f6fa;--card:#ffffff;--text:#222;
  --primary:#0d6efd;
  --dark-bg:#1f2933;--dark-card:#2d3748;--dark-text:#e5e7eb;
}
body{
  font-family:system-ui,Arial;
  margin:14px;
  background:var(--bg);
  color:var(--text);
}
body.dark{background:var(--dark-bg);color:var(--dark-text)}

h2{margin:0 0 10px;font-size:26px}

.topbar{
  display:flex;
  gap:8px;
  flex-wrap:nowrap;
  overflow-x:auto;
  margin-bottom:10px;
}
.btn{
  padding:8px 12px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  white-space:nowrap;
  font-weight:600;
}
.btn-primary{background:var(--primary);color:#fff}
.btn-secondary{background:#e5e7eb}

input[type="text"]{
  width:100%;
  max-width:420px;
  padding:10px;
  border-radius:10px;
  border:1px solid #ccc;
  margin-bottom:10px;
}

table{
  width:100%;
  border-collapse:collapse;
  background:var(--card);
  border-radius:10px;
  overflow:hidden;
}
th,td{
  padding:10px;
  border-bottom:1px solid #ddd;
  font-size:14px;
}
th{
  background:#e9edf3;
  text-align:left;
}

.compact th,.compact td{padding:6px;font-size:13px}

body.dark table{background:var(--dark-card)}
body.dark th{background:#111827;color:var(--dark-text)}

.pagination{
  margin-top:12px;
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}

.highlight{
  background:#ffeaa7 !important;
  font-weight:700;
}

.modal-backdrop{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.modal{
  background:#fff;
  padding:14px;
  border-radius:12px;
  width:95%;
  max-width:420px;
}
#qr-reader{
  width:100%;
  height:220px;
}
</style>
</head>

<body>

<h2>Spare Parts Search</h2>

<div class="topbar">
  <button id="btnScan" class="btn btn-primary">ðŸ“· Scan</button>
  <button id="btnRefresh" class="btn btn-secondary">â†» Refresh</button>
  <button id="btnExport" class="btn btn-secondary">â¬‡ Export CSV</button>
  <label>Dark <input type="checkbox" id="darkToggle"></label>
  <label>Compact <input type="checkbox" id="compactToggle"></label>
</div>

<input id="search" type="text" placeholder="Search like: coro pad 2093">

<table>
<thead>
<tr>
  <th>#</th>
  <th>Item No</th>
  <th>Part No</th>
  <th>Description</th>
  <th>Category</th>
  <th>Qty</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<div class="pagination">
  <button id="prev" class="btn btn-secondary">Prev</button>
  <span id="pageInfo"></span>
  <button id="next" class="btn btn-secondary">Next</button>
  <input id="jump" type="number" placeholder="Page #" style="width:80px">
  <button id="jumpBtn" class="btn btn-secondary">Go</button>
</div>

<!-- Scanner -->
<div id="qrBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Scan QR / Barcode</h3>
    <div id="qr-reader"></div>
    <button id="qrClose" class="btn btn-secondary">Close</button>
  </div>
</div>

<!-- Sound -->
<audio id="beep" preload="auto">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script>
const URL = "https://sheetdb.io/api/v1/bvdsyfvkla1lv";
const PER_PAGE = 50;

let allData=[], page=1, scanner=null, highlight=null;

const tbody = document.getElementById("tbody");
const search = document.getElementById("search");
const pageInfo = document.getElementById("pageInfo");
const beep = document.getElementById("beep");

/* ðŸ”‘ Normalize text */
function normalize(t){
  return (t||"")
    .toLowerCase()
    .replace(/[^a-z0-9]+/g," ")
    .replace(/\s+/g," ")
    .trim();
}

/* Fix trailing-space keys */
function cleanKeys(o){
  const r={};
  for(const k in o) r[k.trim()] = String(o[k]||"").trim();
  return r;
}

/* Load data */
async function loadData(){
  try{
    const res = await fetch(URL);
    const json = await res.json();
    allData = prepare(json);
    localStorage.setItem("spare_cache", JSON.stringify(allData));
  }catch{
    allData = JSON.parse(localStorage.getItem("spare_cache")||"[]");
    alert("Offline mode");
  }
  page=1; render();
}

/* Prepare rows */
function prepare(rows){
  return rows.map(r=>{
    r = cleanKeys(r);
    r._s = normalize(
      r["item no"]+" "+
      r["part no"]+" "+
      r["description"]+" "+
      r["category"]+" "+
      r["qty"]
    );
    return r;
  });
}

/* ðŸ”¥ TRUE TOKEN PREFIX SEARCH */
function render(){
  const tokens = normalize(search.value).split(" ").filter(Boolean);

  const filtered = tokens.length
    ? allData.filter(r=>{
        const words = r._s.split(" ");
        return tokens.every(t =>
          words.some(w => w.startsWith(t))
        );
      })
    : allData;

  const pages = Math.max(1, Math.ceil(filtered.length/PER_PAGE));
  if(page>pages) page=pages;

  const start = (page-1)*PER_PAGE;
  const view = filtered.slice(start, start+PER_PAGE);

  tbody.innerHTML = view.map((r,i)=>`
    <tr class="${highlight && r._s.includes(normalize(highlight))?'highlight':''}">
      <td>${start+i+1}</td>
      <td>${r["item no"]}</td>
      <td>${r["part no"]}</td>
      <td>${r["description"]}</td>
      <td>${r["category"]}</td>
      <td>${r["qty"]}</td>
    </tr>
  `).join("");

  pageInfo.textContent = `Page ${page} of ${pages} (${filtered.length})`;
}

/* Debounced search */
let timer;
search.oninput = ()=>{
  clearTimeout(timer);
  timer = setTimeout(()=>{page=1; render();},200);
};

/* Pagination */
prev.onclick = ()=>{ if(page>1){page--; render();} };
next.onclick = ()=>{ page++; render(); };
jumpBtn.onclick = ()=>{
  const p = parseInt(jump.value);
  if(p>0){ page=p; render(); }
};

/* Export CSV */
btnExport.onclick = ()=>{
  let csv="Item No,Part No,Description,Category,Qty\n";
  allData.forEach(r=>{
    csv+=`"${r["item no"]}","${r["part no"]}","${r["description"]}","${r["category"]}","${r["qty"]}"\n`;
  });
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="spare_parts.csv";
  a.click();
};

/* Scanner */
btnScan.onclick = ()=>{
  qrBackdrop.style.display="flex";
  scanner = new Html5Qrcode("qr-reader");
  scanner.start(
    {facingMode:"environment"},
    {fps:10, qrbox:{width:180,height:180}},
    txt=>{
      beep.play().catch(()=>{});
      navigator.vibrate && navigator.vibrate([300,150,300,150,300]);
      highlight = txt;
      search.value = txt;
      page=1;
      render();
      scanner.stop();
      qrBackdrop.style.display="none";
    }
  );
};

qrClose.onclick = ()=>{
  scanner && scanner.stop();
  qrBackdrop.style.display="none";
};

btnRefresh.onclick = loadData;

/* Toggles */
darkToggle.onchange = ()=>document.body.classList.toggle("dark", darkToggle.checked);
compactToggle.onchange = ()=>document.body.classList.toggle("compact", compactToggle.checked);

/* Init */
loadData();
</script>

</body>
</html>