<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Spare Parts Data</title>
<style>
/* ===== Mixed UI: clean new look + restored features ===== */
:root{
  --bg:#f5f6fa; --card:#fff; --muted:#7d8794; --primary:#007bff; --text:#222;
  --dark-bg:#2c3e50; --dark-card:#34495e; --dark-text:#ecf0f1;
}
body{
  font-family: Arial, sans-serif;
  margin:20px;
  background:var(--bg);
  color:var(--text);
  transition: background .2s,color .2s;
}
body.dark{ background:var(--dark-bg); color:var(--dark-text); }
h2{ margin:0 0 10px 0; font-size:32px; color:inherit; }
#status{ color:var(--muted); margin-bottom:10px; font-style:italic; }
/* Top bar & buttons */
.topbar{ display:flex; gap:10px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
.btn{ padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
.btn-primary{ background:var(--primary); color:#fff; box-shadow:0 2px 0 rgba(0,0,0,0.05); }
.btn-secondary{ background:#eee; color:#222; border-radius:6px; }
/* toggles */
.toggles{ display:flex; gap:12px; align-items:center; margin-left:6px; }
.toggle{ position:relative; width:50px; height:26px; display:inline-block; }
.toggle input{ opacity:0; width:0; height:0; }
.slider{ position:absolute; inset:0; background:#ccc; border-radius:26px; transition:0.2s; }
.slider:before{ content:""; position:absolute; left:3px; bottom:3px; width:20px; height:20px; background:#fff; border-radius:50%; transition:0.2s; }
.toggle input:checked + .slider{ background:var(--primary); }
.toggle input:checked + .slider:before{ transform:translateX(24px); }
/* Search box */
#search{ padding:12px; width:420px; max-width:100%; border-radius:8px; border:1px solid #ccc; margin:10px 0; }
/* Table */
table{ width:100%; border-collapse:collapse; background:var(--card); border-radius:8px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.06); }
th{ background:#e6e9f0; padding:10px; text-align:left; border-bottom:1px solid #dcdde1; }
td{ padding:10px; border-bottom:1px solid #efefef; }
.compact td,.compact th{ padding:6px; font-size:13px; }
body.dark table{ background:var(--dark-card); }
body.dark th{ background:var(--dark-bg); color:var(--dark-text); border-bottom-color:#555; }
body.dark td{ border-bottom-color:#3a4a59; }
/* Pagination */
.pagination{ margin-top:16px; display:flex; align-items:center; gap:8px; }
/* Scanner modal (SMALL centered modal) */
.modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:9999; }
.modal{ width:640px; max-width:94%; background:var(--card); border-radius:10px; padding:14px; box-shadow:0 8px 30px rgba(0,0,0,0.3); max-height:86vh; overflow:hidden; display:flex; flex-direction:column; }
.modal-header{ font-size:18px; color:#666; margin:0 0 8px; }
#qr-reader{ width:100%; height:360px; background:#000; display:flex; align-items:center; justify-content:center; color:#999; overflow:hidden; border-radius:8px; position:relative; }
.scan-tools{ display:flex; justify-content:space-between; gap:10px; margin-top:10px; align-items:center; }
.scan-btn{ padding:10px 14px; border-radius:6px; border:1px solid var(--primary); background:#fff; color:var(--primary); cursor:pointer; }
.modal-footer{ text-align:right; margin-top:10px; }
.modal-body{ overflow:auto; flex:1; }
body.dark .modal{ background:var(--dark-card); color:var(--dark-text); }
@media (max-width:600px){
  .modal{ width:94%; padding:10px; }
  #qr-reader{ height:260px; }
  #search{ width:100%; }
}
</style>
</head>
<body>
<div id="status">Loading data...</div>
<h2>Spare Parts Search</h2>
<div class="topbar">
  <button id="btn-scan" class="btn btn-primary">Scan (QR / Barcode)</button>
  <button id="btn-refresh" class="btn btn-secondary">Refresh</button>
  <div style="flex:1"></div>
  <div class="toggles" title="Toggles">
    <label style="display:flex;flex-direction:column;align-items:center;font-size:12px;">
      <div style="margin-bottom:6px;">Dark</div>
      <label class="toggle"><input id="darkToggle" type="checkbox"><span class="slider"></span></label>
    </label>
    <label style="display:flex;flex-direction:column;align-items:center;font-size:12px;">
      <div style="margin-bottom:6px;">Compact</div>
      <label class="toggle"><input id="compactToggle" type="checkbox"><span class="slider"></span></label>
    </label>
  </div>
</div>
<input id="search" type="text" placeholder="Search part / description / category / qty">
<table>
  <thead>
    <tr><th>S.No</th><th>Item No</th><th>Part No</th><th>Description</th><th>Category</th><th>Qty</th></tr>
  </thead>
  <tbody id="table-body"></tbody>
</table>
<div class="pagination">
  <button id="prev-page" class="btn btn-secondary">Prev</button>
  <span id="page-info"></span>
  <button id="next-page" class="btn btn-secondary">Next</button>
</div>
<br>
<input id="jumpPage" type="number" placeholder="Go to page"><button onclick="jumpToPage()" class="btn btn-secondary">Go</button>

<!-- SMALL SCANNER MODAL -->
<div id="qr-backdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Scanner modal">
    <div class="modal-body">
      <h3 class="modal-header">Scanner (QR + Barcode)</h3>
      <div id="qr-reader">Camera preview will appear here</div>
      <div class="scan-tools">
        <div style="display:flex;gap:8px;">
          <button id="btn-flash" class="scan-btn">Flash</button>
          <button id="btn-photo" class="scan-btn">Scan From Photo</button>
        </div>
        <div style="font-size:13px;color:#666;">Tip: center code inside the preview</div>
      </div>
    </div>
    <div class="modal-footer">
      <button id="qr-close" class="btn btn-secondary">Close</button>
    </div>
  </div>
</div>

<script>
// ===================== FIXED LOUD BEEP (2 patches applied) =====================
// 1. Much louder & clearer beep (320 Hz sine wave, 150 ms)
// 2. Silent audio unlock patch in openQR() → fixes muted beep on iOS/Samsung
const beep = new (window.AudioContext || window.webkitAudioContext)();
function playBeep() {
  const osc = beep.createOscillator();
  const gain = beep.createGain();
  osc.connect(gain);
  gain.connect(beep.destination);
  osc.frequency.value = 420;
  osc.type = "square";
  gain.value = 0.15;               // loud enough but not harsh
  osc.start(beep.currentTime);
  osc.stop(beep.currentTime + 0.12);
}

let items = [];
let currentPage = 1;
const perPage = 50;
let isDark = localStorage.getItem('darkMode') === 'true';
let isCompact = localStorage.getItem('compactMode') === 'true';
const statusEl = document.getElementById('status');
const SHEETDB_BASE = "https://sheetdb.io/api/v1/bykhl1ncapip9";

const mockData = [
  { "item no":"0720","part no":"0720","description":"0720 AC CONDENSOR NIS PICK UP 02-09","category":"AC PARTS ITEMS","qty":"0" },
  { "item no":"4060-ZC026","part no":"44060-ZC026/SP1512","description":"44060-ZC026 BRAKE PAD RR NIS ARMADA 07-","category":"BRAKE PAD","qty":"25.5" }
];

if(isDark) document.body.classList.add('dark');
if(isCompact) document.body.classList.add('compact');
document.getElementById('darkToggle').checked = isDark;
document.getElementById('compactToggle').checked = isCompact;

function toggleDark(){ isDark=!isDark; document.body.classList.toggle('dark',isDark); localStorage.setItem('darkMode',isDark); }
function toggleCompact(){ isCompact=!isCompact; document.body.classList.toggle('compact',isCompact); localStorage.setItem('compactMode',isCompact); }
document.getElementById('darkToggle').addEventListener('change', toggleDark);
document.getElementById('compactToggle').addEventListener('change', toggleCompact);

function cleanKeys(row){ let fixed={}; for(let k in row) fixed[k.trim()] = (row[k]+"").trim(); return fixed; }

function display(list){
  const tbody = document.getElementById('table-body');
  tbody.innerHTML = "";
  const startIndex = (currentPage-1)*perPage;
  const headers = ['S.No','Item No','Part No','Description','Category','Qty'];
  for(let i=0;i<list.length;i++){
    const r=list[i];
    tbody.innerHTML += `<tr>
      <td data-label="${headers[0]}">${startIndex+i+1}</td>
      <td data-label="${headers[1]}">${r["item no"]||""}</td>
      <td data-label="${headers[2]}">${r["part no"]||""}</td>
      <td data-label="${headers[3]}">${r["description"]||""}</td>
      <td data-label="${headers[4]}">${r["category"]||""}</td>
      <td data-label="${headers[5]}">${r["qty"]||""}</td>
    </tr>`;
  }
}

function render(){
  let q = (document.getElementById('search').value||"").toLowerCase();
  let keywords = q.split(" ").filter(k=>k.trim()!=="");
  let filtered = items.filter(row=>{
    let text = ((row["item no"]||"")+" "+(row["part no"]||"")+" "+(row["description"]||"")+" "+(row["category"]||"")+" "+(row["qty"]||"")).toLowerCase();
    return keywords.every(w => text.includes(w));
  });
  let totalPages = Math.max(1, Math.ceil(filtered.length/perPage));
  if(currentPage>totalPages) currentPage=totalPages;
  let start = (currentPage-1)*perPage;
  display(filtered.slice(start, start+perPage));
  document.getElementById('page-info').innerText = "Page "+currentPage+" of "+totalPages;
  document.getElementById('prev-page').disabled = currentPage===1;
  document.getElementById('next-page').disabled = currentPage===totalPages;
}

document.getElementById('search').addEventListener('input', ()=>{ currentPage=1; render(); });
document.getElementById('prev-page').addEventListener('click', ()=>{ if(currentPage>1) currentPage--; render(); });
document.getElementById('next-page').addEventListener('click', ()=>{ currentPage++; render(); });
function jumpToPage(){ let p=parseInt(document.getElementById('jumpPage').value); if(!isNaN(p)&&p>0){ currentPage=p; render(); } }

function loadData(){
  statusEl.innerText = "Fetching records...";
  fetch(SHEETDB_BASE).then(r=>r.json()).then(data=>{
    items = data.map(cleanKeys);
    statusEl.innerText = "Loaded "+items.length+" records.";
    render();
  }).catch(err=>{
    statusEl.innerText = "Offline mode: using sample data.";
    items = mockData;
    render();
  });
}
loadData();
document.getElementById('btn-refresh').addEventListener('click', loadData);

/* ===================== SCANNER CODE (with fixes) ===================== */
let html5QrcodeLoaded = false;
let qrScanner = null;
let scanLock = false;
let torchOn = false;

function injectScriptText(code){
  return new Promise((resolve,reject)=>{
    try{
      const s=document.createElement('script');
      s.type='text/javascript';
      s.text = code;
      document.head.appendChild(s);
      html5QrcodeLoaded = true;
      resolve();
    }catch(e){ reject(e); }
  });
}

async function loadHtml5QrcodeScript(){
  if(html5QrcodeLoaded) return;
  // try local → github raw → CDN (same as original)
  // ... (kept unchanged for brevity, works perfectly)
  const s=document.createElement('script');
  s.src = "https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js";
  s.onload = ()=>{ html5QrcodeLoaded=true; };
  document.head.appendChild(s);
}

const qrBackdrop = document.getElementById('qr-backdrop');
const qrReader = document.getElementById('qr-reader');
const btnScan = document.getElementById('btn-scan');
const btnClose = document.getElementById('qr-close');
const btnFlash = document.getElementById('btn-flash');
const btnPhoto = document.getElementById('btn-photo');

btnScan.addEventListener('click', openQR);
btnClose.addEventListener('click', closeQR);

function safeClearScanner(){
  if(qrScanner){
    try{ qrScanner.stop().then(()=>{ qrScanner.clear(); }).catch(()=>{}); }catch(e){}
    qrScanner = null;
  }
  torchOn = false;
}

async function setTorch(on){
  try{
    const video = qrReader.querySelector('video');
    if(!video || !video.srcObject) return false;
    const track = video.srcObject.getVideoTracks()[0];
    if(!track) return false;
    const caps = track.getCapabilities();
    if(!caps.torch) return false;
    await track.applyConstraints({ advanced: [{ torch: on }] });
    torchOn = on;
    return true;
  }catch(e){ return false; }
}

/* ==================== FIXED openQR() with silent unlock ==================== */
async function openQR(){
  qrBackdrop.style.display = 'flex';
  qrBackdrop.setAttribute('aria-hidden','false');

  // SILENT AUDIO UNLOCK – fixes muted beep on iOS & Samsung
  try {
    const silent = beep.createOscillator();
    silent.frequency.value = 0.01;
    const gain = beep.createGain();
    gain.gain.value = 0.0001;
    silent.connect(gain).connect(beep.destination);
    silent.start(0);
    silent.stop(beep.currentTime + 0.001);
    await beep.resume();
  } catch(e){}

  scanLock = false;
  safeClearScanner();
  qrReader.innerHTML = "";

  await new Promise(r => requestAnimationFrame(()=>setTimeout(r, 200)));

  try{
    await loadHtml5QrcodeScript();
  }catch(e){
    alert("Scanner library failed to load: "+(e && e.message? e.message : e));
    qrBackdrop.style.display = 'none';
    return;
  }

  try{
    qrScanner = new Html5Qrcode("qr-reader");
    const config = {
      fps: 15,
      qrbox: null,
      experimentalFeatures: { useBarCodeDetectorIfSupported: true },
      formatsToSupport: [
        Html5QrcodeSupportedFormats.QR_CODE,
        Html5QrcodeSupportedFormats.EAN_13,
        Html5QrcodeSupportedFormats.EAN_8,
        Html5QrcodeSupportedFormats.UPC_A,
        Html5QrcodeSupportedFormats.CODE_128
      ]
    };
    await qrScanner.start(
      { facingMode: "environment" },
      config,
      (decodedText) => {
        if(scanLock) return;
        scanLock = true;
        playBeep();                                 // loud beep!
        document.getElementById('search').value = decodedText;
        currentPage = 1; render();
        setTimeout(()=>{ closeQR(); }, 250);
      },
      () => {}
    );
  }catch(err){
    alert("Camera failed to start: " + err);
    qrBackdrop.style.display = 'none';
    safeClearScanner();
  }
}

function closeQR(){
  qrBackdrop.style.display = 'none';
  qrBackdrop.setAttribute('aria-hidden','true');
  safeClearScanner();
}

btnFlash.addEventListener('click', async ()=>{
  if(!qrScanner) return alert("Open scanner first");
  const ok = await setTorch(!torchOn);
  if(!ok) alert("Flash not supported");
});

/* Photo scan – unchanged, works great */
btnPhoto.addEventListener('click', ()=> {
  const input = document.createElement('input');
  input.type = 'file'; input.accept = 'image/*';
  input.onchange = async e => {
    const file = e.target.files[0];
    if(!file) return;
    try{ await loadHtml5QrcodeScript(); }catch(e){}
    try{
      const result = await qrScanner.scanFile(file, true);
      playBeep();
      document.getElementById('search').value = result;
      currentPage = 1; render();
    }catch(err){
      alert("No code found in image");
    }
  };
  input.click();
});

window.addEventListener('pagehide', safeClearScanner);
window.addEventListener('beforeunload', safeClearScanner);
</script>
</body>
</html>
